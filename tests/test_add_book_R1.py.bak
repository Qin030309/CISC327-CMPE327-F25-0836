import pytest
from unittest.mock import Mock
from services.library_service import add_book_to_catalog
import random

def unique_isbn():
    """生成唯一的 13 位数字 ISBN"""
    return str(random.randint(10**12, 10**13 - 1))


# -------------------------
# Valid Input Tests (Stub DB)
# -------------------------
def test_add_book_valid_input(mocker):
    """有效图书应成功添加"""
    # stub 数据库查询和插入
    mocker.patch("services.library_service.get_book_by_isbn", return_value=None)
    mocker.patch("services.library_service.insert_book", return_value=True)

    for _ in range(3):
        isbn = unique_isbn()
        success, message = add_book_to_catalog("Test Book", "Test Author", isbn, 5)
        assert success is True
        assert "successfully" in message.lower()


def test_add_book_empty_title(mocker):
    mocker.patch("services.library_service.get_book_by_isbn", return_value=None)
    mocker.patch("services.library_service.insert_book", return_value=True)

    isbn = unique_isbn()
    success, message = add_book_to_catalog("", "Test Author", isbn, 5)
    assert success is False
    assert "title" in message.lower()


def test_add_book_total_copies_invalid(mocker):
    mocker.patch("services.library_service.get_book_by_isbn", return_value=None)
    mocker.patch("services.library_service.insert_book", return_value=True)

    for copies in [-1, 0, -10]:
        isbn = unique_isbn()
        success, message = add_book_to_catalog("Valid Title", "Valid Author", isbn, copies)
        assert success is False
        assert "total copies" in message.lower()
