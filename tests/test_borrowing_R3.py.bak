import pytest
import services.library_service as library_service

# =====================================
# R3: Borrow Book Tests
# =====================================

def test_add_book_success(monkeypatch):
    # 正确路径：直接用 library_service 模块对象
    monkeypatch.setattr(library_service, "get_book_by_isbn", lambda isbn: None)
    monkeypatch.setattr(library_service, "add_book_to_catalog", lambda title, author, isbn, copies: (True, "Successfully added"))

    success, message = library_service.add_book_to_catalog("Valid Book", "Valid Author", "1234567890123", 5)
    assert success
    assert "successfully added" in message.lower()

def test_borrow_book_valid(monkeypatch):
    # Stub get_book_by_id 返回可借的书
    monkeypatch.setattr(library_service, "get_book_by_id", lambda book_id: {
        "book_id": book_id,
        "title": "Stub Book",
        "author": "Stub Author",
        "isbn": "1234567890123",
        "total_copies": 5,
        "available_copies": 5
    })

    monkeypatch.setattr(library_service, "borrow_book_by_patron", lambda patron_id, book_id: (True, "Borrowed successfully"))

    success, message = library_service.borrow_book_by_patron("123456", 1)
    assert success
    assert "borrowed successfully" in message.lower()

def test_borrow_book_invalid_patron(monkeypatch):
    monkeypatch.setattr(library_service, "borrow_book_by_patron", lambda patron_id, book_id: (False, "Invalid patron ID"))

    success, message = library_service.borrow_book_by_patron("abc123", 1)
    assert not success
    assert "invalid patron" in message.lower()

def test_return_book_not_borrowed(monkeypatch):
    monkeypatch.setattr(library_service, "return_book_by_patron", lambda patron_id, book_id: (False, "Book not borrowed"))

    success, message = library_service.return_book_by_patron("123456", 99)
    assert not success
    assert "not borrowed" in message.lower()

def test_return_book_on_time(monkeypatch):
    monkeypatch.setattr(library_service, "return_book_by_patron", lambda patron_id, book_id: (True, "Returned successfully"))

    success, message = library_service.return_book_by_patron("123456", 1)
    assert success
    assert "returned successfully" in message.lower()
