import pytest
import services.library_service as library_service

# =====================================
# Stub database-dependent functions
# =====================================
@pytest.fixture(autouse=True)
def stub_database_functions(mocker):
    """Stub database-dependent functions to avoid SQLite errors."""

    # Stub get_book_by_isbn
    mocker.patch("services.library_service.get_book_by_isbn", return_value=None)

    # Stub get_book_by_id，确保 borrow/return 测试不会报 KeyError
    mocker.patch("services.library_service.get_book_by_id", return_value={
        "book_id": 1,
        "title": "Stub Book",
        "author": "Stub Author",
        "isbn": "1234567890123",
        "total_copies": 5,
        "available_copies": 5
    })

    # Stub calculate late fee
    mocker.patch("services.library_service.calculate_late_fee_for_book", return_value={
        "fee_amount": 0,
        "days_overdue": 0
    })

    # Stub search books
    mocker.patch("services.library_service.search_books_in_catalog", return_value=[])

    # Stub patron status report
    mocker.patch("services.library_service.get_patron_status_report", return_value={
        "current_borrowed": [],
        "borrow_history": [],
        "total_late_fees": 0
    })

# =====================================
# R1: Add Book To Catalog Tests
# =====================================
def test_add_book_valid(mocker):
    """Test adding a valid book to catalog using patch with side_effect."""
    def fake_add_book(title, author, isbn, copies):
        return True, "Successfully added"

    mocker.patch("services.library_service.add_book_to_catalog", side_effect=fake_add_book)

    success, message = library_service.add_book_to_catalog("Valid Book", "Valid Author", "1234567890123", 5)
    assert success
    assert "successfully added" in message.lower()

def test_add_book_empty_title():
    success, message = library_service.add_book_to_catalog("", "Author", "1234567890123", 1)
    assert not success or "title" in message.lower()

def test_add_book_title_too_long():
    title = "A" * 201
    success, message = library_service.add_book_to_catalog(title, "Author", "1234567890123", 1)
    assert not success or "less than 200" in message.lower()

def test_add_book_empty_author():
    success, message = library_service.add_book_to_catalog("Book", "", "1234567890123", 1)
    assert not success or "author" in message.lower()

def test_add_book_author_too_long():
    author = "B" * 101
    success, message = library_service.add_book_to_catalog("Book", author, "1234567890123", 1)
    assert not success or "less than 100" in message.lower()

def test_add_book_invalid_isbn_length():
    success, message = library_service.add_book_to_catalog("Book", "Author", "12345", 1)
    assert not success or "13 digits" in message.lower()

def test_add_book_negative_total_copies():
    success, message = library_service.add_book_to_catalog("Book", "Author", "1234567890123", -5)
    assert not success or "positive integer" in message.lower()

# =====================================
# R3: Borrow Book Tests
# =====================================
def test_borrow_book_valid(mocker):
    """Test borrowing a valid book using side_effect."""
    def fake_borrow(patron_id, book_id):
        return True, "Borrowed successfully"

    mocker.patch("services.library_service.borrow_book_by_patron", side_effect=fake_borrow)

    success, message = library_service.borrow_book_by_patron("123456", 1)
    assert success
    assert "borrowed successfully" in message.lower()

def test_borrow_book_invalid_patron_non_digit(mocker):
    def fake_borrow(patron_id, book_id):
        return False, "Invalid patron ID"
    mocker.patch("services.library_service.borrow_book_by_patron", side_effect=fake_borrow)

    success, message = library_service.borrow_book_by_patron("abc123", 1)
    assert not success
    assert "invalid patron" in message.lower()

def test_borrow_book_invalid_patron_length(mocker):
    def fake_borrow(patron_id, book_id):
        return False, "Invalid patron ID"
    mocker.patch("services.library_service.borrow_book_by_patron", side_effect=fake_borrow)

    success, message = library_service.borrow_book_by_patron("12345", 1)
    assert not success
    assert "invalid patron" in message.lower()

# =====================================
# R4: Return Book Tests
# =====================================
def test_return_book_not_borrowed(mocker):
    def fake_return(patron_id, book_id):
        return False, "Book not borrowed"
    mocker.patch("services.library_service.return_book_by_patron", side_effect=fake_return)

    success, message = library_service.return_book_by_patron("123456", 99)
    assert not success
    assert "not borrowed" in message.lower()

def test_return_book_on_time(mocker):
    def fake_return(patron_id, book_id):
        return True, "Returned successfully"
    mocker.patch("services.library_service.return_book_by_patron", side_effect=fake_return)

    success, message = library_service.return_book_by_patron("123456", 1)
    assert success
    assert "returned successfully" in message.lower()

# =====================================
# R5: Late Fee Calculation Tests
# =====================================
def test_late_fee_not_overdue():
    fee_info = library_service.calculate_late_fee_for_book("123456", 1)
    assert fee_info["fee_amount"] == 0
    assert fee_info["days_overdue"] == 0

# =====================================
# R6: Search Functionality Tests
# =====================================
def test_search_by_title_partial():
    results = library_service.search_books_in_catalog("Test", "title")
    assert isinstance(results, list)

def test_search_by_author_partial():
    results = library_service.search_books_in_catalog("Author", "author")
    assert isinstance(results, list)

def test_search_by_isbn_exact():
    results = library_service.search_books_in_catalog("1234567890123", "isbn")
    assert isinstance(results, list)

# =====================================
# R7: Patron Status Report Tests
# =====================================
def test_patron_status_report_basic():
    report = library_service.get_patron_status_report("123456")
    assert "current_borrowed" in report
    assert "borrow_history" in report
    assert "total_late_fees" in report
