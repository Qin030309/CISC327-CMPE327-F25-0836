# tests/test_catalog_display_R2.py
import pytest
from services import library_service

# -----------------------------
# Helper to generate unique ISBNs
# -----------------------------
def unique_isbn():
    import random
    return str(random.randint(1000000000000, 9999999999999))

# -----------------------------
# Fixtures to stub database functions
# -----------------------------
@pytest.fixture(autouse=True)
def stub_database_functions(mocker):
    """Stub all database-dependent functions in library_service."""
    # Stub add_book_to_catalog
    catalog = []

    def fake_add_book(title, author, isbn, copies):
        if not title or not author or len(isbn) != 13 or copies <= 0:
            return False, "Invalid input"
        book = {
            "id": len(catalog) + 1,
            "title": title,
            "author": author,
            "isbn": isbn,
            "total_copies": copies,
            "available_copies": copies
        }
        catalog.append(book)
        return True, "Successfully added"

    def fake_get_all_books():
        return catalog

    # Patch the functions
    mocker.patch("services.library_service.add_book_to_catalog", side_effect=fake_add_book)
    mocker.patch("services.library_service.get_all_books", side_effect=fake_get_all_books)

# -----------------------------
# Test Cases for R2
# -----------------------------
def test_empty_catalog():
    """Empty catalog should return a list (possibly empty)"""
    books = library_service.get_all_books()
    assert isinstance(books, list)

def test_add_single_book_display():
    """Add a single book and verify it appears with correct fields"""
    isbn = unique_isbn()
    success, _ = library_service.add_book_to_catalog("Book One", "Author A", isbn, 3)
    assert success is True

    books = library_service.get_all_books()
    book = next(b for b in books if b["isbn"] == isbn)
    assert book["title"] == "Book One"
    assert book["author"] == "Author A"
    assert book["total_copies"] == 3
    assert book["available_copies"] == 3
    assert "id" in book
    assert "isbn" in book

def test_add_multiple_books_display():
    """Add multiple books and check all appear in catalog"""
    isbn1 = unique_isbn()
    isbn2 = unique_isbn()
    isbn3 = unique_isbn()

    library_service.add_book_to_catalog("Book Two", "Author B", isbn1, 2)
    library_service.add_book_to_catalog("Book Three", "Author C", isbn2, 1)
    library_service.add_book_to_catalog("Book Four", "Author D", isbn3, 5)

    books = library_service.get_all_books()
    added_isbns = [isbn1, isbn2, isbn3]
    found_books = [b for b in books if b["isbn"] in added_isbns]
    assert len(found_books) == 3

def test_add_book_invalid_inputs():
    """Test invalid inputs when adding a book"""
    # title missing
    success, _ = library_service.add_book_to_catalog("", "Author H", unique_isbn(), 2)
    assert success is False
    # author missing
    success, _ = library_service.add_book_to_catalog("Title H", "", unique_isbn(), 2)
    assert success is False
    # ISBN wrong length
    success, _ = library_service.add_book_to_catalog("Title I", "Author I", "123", 2)
    assert success is False
    # total_copies <= 0
    success, _ = library_service.add_book_to_catalog("Title J", "Author J", unique_isbn(), 0)
    assert success is False
